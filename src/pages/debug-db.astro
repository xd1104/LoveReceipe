---
import Layout from "../layouts/Layout.astro";
---

<Layout>
    <main class="mx-auto max-w-4xl p-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">資料庫連線除錯</h1>
        
        <div id="db-debug" class="space-y-4">
            <div class="bg-gray-100 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2">Supabase 連線狀態</h2>
                <div id="connection-status">檢查中...</div>
            </div>
            
            <div class="bg-gray-100 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2">資料表檢查</h2>
                <div id="table-status">檢查中...</div>
            </div>
            
            <div class="bg-gray-100 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2">測試查詢</h2>
                <div id="query-test">測試中...</div>
            </div>
        </div>
    </main>
</Layout>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const connectionStatus = document.getElementById('connection-status');
        const tableStatus = document.getElementById('table-status');
        const queryTest = document.getElementById('query-test');
        
        try {
            // 測試 Supabase 連線
            const { supabase } = await import('../lib/supabase');
            connectionStatus.innerHTML = '✅ Supabase 連線成功';
            
            // 檢查認證狀態
            const { data: { session } } = await supabase.auth.getSession();
            if (!session?.user) {
                throw new Error('請先登入');
            }
            
            // 使用 Supabase 允許的方式檢查資料表
            // 直接查詢各個表來確認是否存在
            const tableChecks = [
                { name: 'profiles', query: () => supabase.from('profiles').select('id').limit(1) },
                { name: 'recipes', query: () => supabase.from('recipes').select('id').limit(1) },
                { name: 'recipe_ingredients', query: () => supabase.from('recipe_ingredients').select('id').limit(1) },
                { name: 'recipe_steps', query: () => supabase.from('recipe_steps').select('id').limit(1) },
                { name: 'tags', query: () => supabase.from('tags').select('id').limit(1) },
                { name: 'recipe_tags', query: () => supabase.from('recipe_tags').select('id').limit(1) },
                { name: 'notes', query: () => supabase.from('notes').select('id').limit(1) },
                { name: 'collaborators', query: () => supabase.from('collaborators').select('id').limit(1) }
            ];
            
            const tableResults = [];
            for (const table of tableChecks) {
                try {
                    const { error } = await table.query();
                    if (error) {
                        tableResults.push({ name: table.name, exists: false, error: error.message });
                    } else {
                        tableResults.push({ name: table.name, exists: true });
                    }
                } catch (err) {
                    tableResults.push({ name: table.name, exists: false, error: err.message });
                }
            }
            
            const existingTables = tableResults.filter(t => t.exists);
            const missingTables = tableResults.filter(t => !t.exists);
            
            if (missingTables.length === 0) {
                tableStatus.innerHTML = '✅ 所有資料表都存在';
            } else {
                const missingNames = missingTables.map(t => t.name).join(', ');
                const errorDetails = missingTables.map(t => `${t.name}: ${t.error}`).join('<br>');
                tableStatus.innerHTML = `❌ 缺少資料表: ${missingNames}<br><small class="text-gray-600">${errorDetails}</small>`;
            }
            
            // 測試簡單查詢
            const { data: recipes, error: recipesError } = await supabase
                .from('recipes')
                .select('id, title, created_at')
                .limit(5);
            
            if (recipesError) {
                queryTest.innerHTML = `❌ 查詢 recipes 表失敗: ${recipesError.message}`;
            } else {
                queryTest.innerHTML = `✅ 查詢成功，找到 ${recipes?.length || 0} 筆食譜`;
            }
            
        } catch (error) {
            console.error('資料庫除錯錯誤:', error);
            connectionStatus.innerHTML = `❌ 錯誤: ${error.message}`;
            tableStatus.innerHTML = `❌ 錯誤: ${error.message}`;
            queryTest.innerHTML = `❌ 錯誤: ${error.message}`;
        }
    });
</script>
