---
import Layout from "../../layouts/Layout.astro";
import RecipeForm from "../../components/RecipeForm.astro";
import { getFullPath } from "../../lib/utils/path";
---

<Layout>
    <main class="mx-auto max-w-4xl p-6">
        <!-- 頁面標題 -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">新增食譜</h1>
            <p class="text-gray-600 mt-1">建立您的新食譜，記錄美好的料理時光</p>
        </div>
        
        <!-- 食譜表單 -->
        <RecipeForm />
    </main>
</Layout>

<script>
  // 處理表單提交
  window.addEventListener('formSubmit', async (e: CustomEvent) => {
    const data = e.detail;
    
    try {
      // 顯示載入狀態
      const submitBtn = document.querySelector('button[type="submit"]') as HTMLButtonElement;
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = '建立中...';
      
      // 檢查認證狀態
      const { supabase } = await import('../../lib/supabase');
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session?.user) {
        throw new Error('請先登入才能新增食譜');
      }
      
      console.log('使用者已登入:', session.user.email);
      
      // 連接到實際的 RecipeService
      console.log('新增食譜資料:', data);
      
      const { RecipeService } = await import('../../lib/services/RecipeService');
      const newRecipe = await RecipeService.createRecipe(data);
      
      console.log('食譜建立成功:', newRecipe);
      
      // 成功後跳轉到食譜列表
      const { getClientNavigationUrl } = await import('../../lib/utils/client-path');
      window.location.href = getClientNavigationUrl('/recipes');
      
    } catch (error) {
      console.error('新增食譜失敗:', error);
      alert('新增食譜失敗，請稍後再試');
      
      // 恢復按鈕狀態
      const submitBtn = document.querySelector('button[type="submit"]') as HTMLButtonElement;
      submitBtn.disabled = false;
      submitBtn.textContent = '建立食譜';
    }
  });
  
  // 處理取消操作
  window.addEventListener('formCancel', async () => {
    if (confirm('確定要取消嗎？未儲存的資料將會遺失。')) {
      const { getClientNavigationUrl } = await import('../../lib/utils/client-path');
      window.location.href = getClientNavigationUrl('/recipes');
    }
  });
</script>
